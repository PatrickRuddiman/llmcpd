name: Commitlint

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  lint-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Install fabric
        run: |
          curl -fsSL https://raw.githubusercontent.com/danielmiessler/fabric/main/scripts/installer/install.sh | bash
      - name: Lint PR squash commit (title + desc) and auto-fix with fabric if needed
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE_URL: "https://api.openai.com/v1"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          set -e
          mkdir -p "$HOME/.config/fabric"
          touch "$HOME/.config/fabric/.env"
          fabric -U
          COMMITLINT_ERRORS=$(mktemp)
          if echo -e "${{ github.event.pull_request.title }}\n\n${{ github.event.pull_request.body }}" | npx -y commitlint >"$COMMITLINT_ERRORS" 2>&1; then
            exit 0
          fi
          TMP_CHANGELOG=$(mktemp)
          COMMITS=$(git rev-list --reverse origin/main..HEAD)
          for COMMIT in $COMMITS; do
            echo "Summarizing $COMMIT..."
            git show $COMMIT --no-patch --format="%h %s" >> "$TMP_CHANGELOG"
            git --no-pager diff $COMMIT^ $COMMIT | fabric -m gpt-5-mini -p summarize_git_diff >> "$TMP_CHANGELOG"
            echo -e "\n---\n" >> "$TMP_CHANGELOG"
          done
          COMMITLINT_MESSAGE=$(cat "$COMMITLINT_ERRORS")
          NEW_BODY=$(cat "$TMP_CHANGELOG" | fabric -m gpt-5-mini -u https://www.conventionalcommits.org/en/v1.0.0/#summary "write a pull request description that passes commitlint. include these commitlint errors and fix them: $COMMITLINT_MESSAGE. start with a summary of key changes emphasising important factors of convential commits (fix, feat, chore, BREAKING CHANGE, etc). followed by followed by a changelog of commits. based on the following commits (dont add comentary as it will be directly used in the pr):")
          PR_COMMITS=$(gh pr view $PR_NUMBER --json commits | jq -r '.commits[] | "\(.messageHeadline): \(.messageBody)"' | paste -sd ", " -)
          NEW_TITLE=$(fabric -m gpt-5-mini "write a conventional commits compatible title for a PR with the following commits and PR description and ensure it passes commitlint. commitlint errors: $COMMITLINT_MESSAGE. commits: $PR_COMMITS; body: $NEW_BODY")
          rm -f "$TMP_CHANGELOG" "$COMMITLINT_ERRORS"
          gh pr edit $PR_NUMBER --title "$NEW_TITLE" --body "$NEW_BODY"
          echo -e "$NEW_TITLE\n\n$NEW_BODY" | npx -y commitlint